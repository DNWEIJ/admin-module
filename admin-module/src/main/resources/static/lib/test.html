<!doctype html>
<html lang="nl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Hotkey Recorder — Werkend</title>

</head>
<body>
<div class="card">
    <h1>Hotkey recorder </h1>
    <p class="hint">Klik <strong>Record</strong>, houd eventuele modifiers (Ctrl/Alt/Shift/Meta) ingedrukt en druk vervolgens de hoofdtoets (bv. <code>U</code>). De combinatie wordt direct vastgelegd.</p>

    <div class="row">
        <input id="combo" type="text" readonly placeholder="Nog geen combinatie" aria-label="Opgenomen combinatie" />
        <button id="recordBtn">Record</button>
        <button id="cancelBtn" class="ghost">Annuleer</button>
    </div>

    <div class="row">
        <input id="url" type="url" placeholder="https://example.com of /pad/naar/pagina" />
        <button id="saveBtn">Opslaan</button>
    </div>

    <div class="bindings" id="bindings"></div>

    <p class="hint">Opname shortcuts: <strong>Esc</strong> = annuleer opname. Tijdens opname worden browser-actie (zoals Ctrl+S) tijdelijk geblokkeerd.</p>
</div>

<script>
    /*
      Robuuste recorder:
      - Start opname: klik Record
      - We luisteren window keydown (capture true) en verzamelen toetsnamen
      - Zodra er een non-modifier key wordt gedrukt finaliseren we de combo
      - Escape annuleert
      - Opslaan in localStorage en globale listener voor afvuren
    */

    const recordBtn = document.getElementById('recordBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const comboInput = document.getElementById('combo');
    const urlInput = document.getElementById('url');
    const saveBtn = document.getElementById('saveBtn');
    const bindingsEl = document.getElementById('bindings');

    let isRecording = false;
    let pressed = new Set();
    let finalizedCombo = null;

    const STORAGE_KEY = 'hotkeys_bindings_v1';
    let bindings = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

    function saveBindings(){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(bindings));
        renderBindings();
    }

    function renderBindings(){
        bindingsEl.innerHTML = '';
        if(bindings.length === 0){
            bindingsEl.innerHTML = '<p class="hint">Nog geen bindings.</p>';
            return;
        }
        bindings.forEach((b, idx) => {
            const div = document.createElement('div');
            div.className = 'binding';
            div.innerHTML = `<div><span class="kbd">${escapeHtml(b.combo)}</span> → <span title="${escapeHtml(b.url)}">${escapeHtml(b.url)}</span></div>`;
            const actions = document.createElement('div');
            const openBtn = document.createElement('button');
            openBtn.textContent = 'Test';
            openBtn.onclick = ()=> window.location.href = b.url;
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Verwijder';
            delBtn.className = 'danger';
            delBtn.onclick = ()=>{
                bindings.splice(idx,1); saveBindings();
            };
            actions.appendChild(openBtn);
            actions.appendChild(delBtn);
            div.appendChild(actions);
            bindingsEl.appendChild(div);
        });
    }

    function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function normalizeKeyName(key){
        if(!key) return '';
        if(key === ' ') return 'Space';
        if(key === 'Control') return 'Ctrl';
        if(key === 'OS') return 'Meta';
        if(key.length === 1) return key.toUpperCase();
        // keep names like ArrowUp, Escape, Enter
        return key;
    }

    function buildComboFromSet(set){
        // ensure modifiers order
        const order = ['Ctrl','Alt','Shift','Meta'];
        const arr = Array.from(set);
        arr.sort((a,b)=>{
            const ia = order.indexOf(a), ib = order.indexOf(b);
            if(ia === -1 && ib === -1) return a.localeCompare(b);
            if(ia === -1) return 1;
            if(ib === -1) return -1;
            return ia - ib;
        });
        return arr.join('+');
    }

    // Start recording
    recordBtn.addEventListener('click', ()=> {
        if(isRecording) return; // ignore if already
        isRecording = true;
        pressed.clear();
        finalizedCombo = null;
        comboInput.value = 'Opnemen... houd modifiers en druk de hoofdtoets';
        // set visual state
        recordBtn.disabled = true;
        recordBtn.textContent = 'Opnemen…';
        // add capture listeners
        window.addEventListener('keydown', recordKeydown, true);
        window.addEventListener('keyup', recordKeyup, true);
    });

    // Cancel recording
    cancelBtn.addEventListener('click', ()=> {
        stopRecording(true);
    });

    // Record keydown (capture)
    function recordKeydown(e){
        // prevent default browser actions while recording, so e.g. Ctrl+S won't trigger save dialog
        e.preventDefault();
        e.stopImmediatePropagation();

        const k = normalizeKeyName(e.key);
        pressed.add(k);

        // Update preview (show modifiers + ... if no main key yet)
        // If only modifiers are present show e.g. "Ctrl+Alt+..."
        const modifiers = ['Ctrl','Alt','Shift','Meta'];
        const hasNonModifier = Array.from(pressed).some(p => !modifiers.includes(p));
        if(!hasNonModifier){
            // show modifiers + ...
            const modDisplay = buildComboFromSet(pressed);
            comboInput.value = modDisplay ? (modDisplay + '+...') : 'Opnemen...';
            return;
        }

        // We have a non-modifier pressed -> finalize immediately
        finalizedCombo = buildComboFromSet(pressed);
        comboInput.value = finalizedCombo;
        // finalize now
        stopRecording(false);
    }

    // Record keyup (capture) - we still prevent propagation to be consistent
    function recordKeyup(e){
        e.preventDefault();
        e.stopImmediatePropagation();
        const k = normalizeKeyName(e.key);
        // remove from pressed set (in case user releases some keys before finalizing)
        pressed.delete(k);
    }

    // Stop recording: either cancelled or finalized
    function stopRecording(cancelled){
        if(!isRecording) return;
        isRecording = false;
        // remove listeners
        window.removeEventListener('keydown', recordKeydown, true);
        window.removeEventListener('keyup', recordKeyup, true);
        recordBtn.disabled = false;
        recordBtn.textContent = 'Record';

        if(cancelled){
            finalizedCombo = null;
            comboInput.value = '';
            return;
        }
        // finalizedCombo already set by keydown handler; if not, build from pressed just in case
        if(!finalizedCombo && pressed.size > 0){
            finalizedCombo = buildComboFromSet(pressed);
            comboInput.value = finalizedCombo;
        }
        // clear pressed
        pressed.clear();
    }

    // Save binding
    saveBtn.addEventListener('click', ()=>{
        const url = urlInput.value.trim();
        if(!finalizedCombo){
            alert('Geen combinatie opgenomen. Klik op Record en druk de combinatie.');
            return;
        }
        if(!url){
            alert('Vul een geldige URL in.');
            return;
        }
        // Overwrite existing combo if present
        bindings = bindings.filter(b => b.combo !== finalizedCombo);
        bindings.push({ combo: finalizedCombo, url });
        saveBindings();
        // reset UI
        finalizedCombo = null;
        comboInput.value = '';
        urlInput.value = '';
    });

    // Global listener to fire hotkeys (non-recording)
    window.addEventListener('keydown', (e)=>{
        if(isRecording) return; // ignore while recording
        // build combo from event
        const parts = [];
        if(e.ctrlKey) parts.push('Ctrl');
        if(e.altKey) parts.push('Alt');
        if(e.shiftKey) parts.push('Shift');
        if(e.metaKey) parts.push('Meta');
        const k = normalizeKeyName(e.key);
        if(!['Ctrl','Alt','Shift','Meta'].includes(k)) parts.push(k);
        const combo = parts.join('+');
        if(!combo) return;
        const match = bindings.find(b => b.combo === combo);
        if(match){
            e.preventDefault();
            // open in same tab:
            window.location.href = match.url;
            // if you prefer new tab: window.open(match.url, '_blank');
        }
    });

    // Allow Esc to cancel while recording
    window.addEventListener('keydown', (e)=>{
        if(isRecording && e.key === 'Escape'){
            e.preventDefault();
            stopRecording(true);
        }
    });

    // init
    renderBindings();
</script>
</body>
</html>