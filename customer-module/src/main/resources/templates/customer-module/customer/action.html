<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:hx-on="http://www.w3.org/1999/xhtml" layout:decorate="~{customer-module/layout.html}">
<head>
    <title>[[#{label.title.customer}]]</title>
    <style>
        .gridSearchWithCheck {
            display: grid;
            grid-template-columns: 4fr repeat(3, 1fr);
            grid-template-rows: 1fr;
            grid-column-gap: 1em;
            grid-row-gap: 0;
        }

        .ac_results {
            position: relative;
            overflow: hidden;
            background-color: var(--pico-background-color);
            width: 100%;
            z-index: 999;
            border: 1px solid black;
            box-shadow: 1px 1px 3px rgba(100, 0, 0, 0.85);
        }

        .ac_results li {
            cursor: default;
            display: block;
            overflow: hidden;
        }

        .ac_results li:nth-child(even) {
            background-color: var(--pico-dropdown-background-color);
        }

        .ac_results li.selected {
            background-color: darkblue;
            color: white;
        }

       .ac_results:empty {
            display: none;
        }

    </style>
    <script>
        let baseUrl;
        let selectedIndex = -1;

        function updateSelection(listItems) {

            if (listItems.length === 0) return;
            listItems.forEach((li, index) => {
                li.classList.toggle("selected", index === selectedIndex);
                if (index === selectedIndex) {
                    li.scrollIntoView({ block: "nearest" });
                }
            });
        }

        function getId(listItems) {

            if (listItems.length === 0) return;
            return Array.from(listItems).filter(li => li.classList.contains("selected"))[0].dataset.id
        }

        function getListItems() {
            return document.querySelectorAll("#input-customerName li");
        }

        function attachMouseHandlers() {
            const listItems = getListItems();

            listItems.forEach((li, index) => {
                li.addEventListener("mouseenter", () => {
                    // highlight hovered item
                    selectedIndex = index;
                    updateSelection(listItems);
                });

                li.addEventListener("click", (event) => {
                    window.location.href = `${window.location.origin}/customer/customer/` + getId(getListItems());
                    event.preventDefault();
                });
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            attachMouseHandlers()
            baseUrl = window.location.href;
            const input = document.getElementById("customerFind");
            selectedIndex = -1;
            input.addEventListener("keydown", (event) => {

                if (event.key === "ArrowDown") {
                    const listItems = getListItems()
                    if (listItems.length === 0) return;

                    if (selectedIndex < listItems.length - 1) {
                        selectedIndex++;
                        updateSelection(listItems);
                    } else if (selectedIndex === -1 && listItems.length > 0) {
                        selectedIndex = 0;
                        updateSelection();
                    }
                    event.preventDefault();
                }
                if (event.key === "ArrowUp") {
                    const listItems = getListItems()
                    if (listItems.length === 0) return;

                    if (selectedIndex > 0) {
                        selectedIndex--;
                        updateSelection(listItems);
                    }
                    event.preventDefault();
                }
                if (event.key === "Enter") {
                    window.location.href = `${window.location.origin}/customer/customer/` + getId(getListItems());
                    event.preventDefault();
                }
            })
        })
    </script>
</head>
<body>

<section layout:fragment="content">
    <div th:replace="~{customer-module/fragments/customer/links}"></div>

    <span class="htmx-indicator"><span aria-busy="true">Searching for customers...</span></span>
    <div class="gridSearchWithCheck">
        <div class="holder">
            <input tabindex="1" list="input-customerName" id="customerFind" class="no-break" type="search" name="searchCriteria" th:placeholder="#{label.customer.search.placeholder}"
                   hx-post="/customer/search/customer"
                   hx-trigger="input[this.value.length >=2] changed delay:500ms, keyup[key=='Enter'], load"
                   hx-target="#input-customerName"
                   hx-indicator=".htmx-indicator"
                   hx-include="#startLastName, #includeStreetName"
                   autocomplete="off">
            <div class="dropdown">
                <div class="ac_results" id="input-customerName" hx-on::after-swap="attachMouseHandlers()"></div>
            </div>
        </div>
        <div>
            <th:block th:insert="~{fragments/elements/select::checkBox('startLastName','last name','form.startLastName','2')}"
                      th:with="tooltip=#{label.tooltip.customer.name}"></th:block>
        </div>
        <div>
            <th:block th:insert="~{fragments/elements/select::checkBox('includeStreetName','street name','form.includeStreetName','3')}"
                      th:with="tooltip=#{label.tooltip.customer.street}"></th:block>
        </div>
        <div>
            <input name="_save" type="submit" th:value="#{label.button.save}" form="createForm">
        </div>
    </div>
    <hr/>
    <form id="createForm"  action="/customer/customer" method="post">
        <!--        <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>-->
        <input id="id" name="id" th:value="${customer.id}" type="hidden"/>
        <input id="version" name="version" th:value="${customer.version}" type="hidden"/>

        <fieldset class="grid">
            <legend>
                <th:block th:utext="#{customer.legend.customerName}"/>
            </legend>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('lastName','customer.lastName','customer.lastName','4')}"></th:block>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('surname','customer.surname','customer.surName','5')}" th:with="required=false"></th:block>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('firstName','customer.firstName','customer.firstName','6')}"></th:block>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('middleInitial','customer.middleInitial','customer.middleInitial','7')}" th:with="required=false"></th:block>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('title','customer.title','customer.title','8')}" th:with="required=false"></th:block>
        </fieldset>
        <fieldset class="grid">
            <legend>
                <th:block th:utext="#{customer.legend.contactInformation}"/>
            </legend>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('email','customer.email','customer.email','9')}" th:with="required=false"></th:block>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('homePhone','customer.homePhone','customer.homePhone','10')}" th:with="required=false"></th:block>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('mobilePhone','customer.mobilePhone','customer.mobilePhone','11')}" th:with="required=false"></th:block>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('workPhone','customer.workPhone','customer.workPhone','12')}" th:with="required=false"></th:block>
        </fieldset>
        <fieldset class="grid">
            <th:block th:insert="~{fragments/elements/dropdown::propDropdown('status','customer.status', 'customer.status', ${statusList}, true,'13')}"></th:block>
            <th:block th:insert="~{fragments/elements/dropdown::propDropdown('newsletter','customer.newsletter', 'customer.newsletter', ${ynvaluesList}, true,'14')}" th:with="required=false"></th:block>
        </fieldset>
        <fieldset class="grid">
            <legend>
                <th:block th:utext="#{customer.legend.addressInformation}"/>
            </legend>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('address1','customer.address1','customer.address1','15')}" th:with="required=false"></th:block>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('address2','customer.address2','customer.address2','16')}" th:with="required=false"></th:block>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('zipCode','customer.zipCode','customer.zipCode','17')}" th:with="pattern='^[1-9][0-9]{3}\s?[A-Z]{2}$', placeholder='XXXZZ'"></th:block>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('city','customer.city','customer.city','18')}"></th:block>
        </fieldset>
        <fieldset class="grid">
            <legend>
                <th:block th:utext="#{customer.legend.emergencyInformation}"/>
            </legend>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('emergencyContact','customer.emergencyContact','customer.emergencyContact','19')}" th:with="required=false"></th:block>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('emergencyContactPhone','customer.emergencyContactPhone','customer.emergencyContactPhone','20')}" th:with="required=false"></th:block>
        </fieldset>
        <fieldset class="grid">
            <legend>
                <th:block th:utext="#{customer.legend.otherInformation}"/>
            </legend>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('previousVeterinarian','customer.previousVeterinarian','customer.previousVeterinarian','21')}" th:with="required=false"></th:block>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('previousVeterinarianPhone','customer.previousVeterinarianPhone','customer.previousVeterinarianPhone','22')}" th:with="required=false"></th:block>
            <th:block th:insert="~{fragments/elements/input::inputHtmlLift('ubn','customer.ubn','customer.ubn','23')}" th:with="required=false"></th:block>
        </fieldset>


        <fieldset class="grid">
            <label for="customer.comments">
                <th:block th:utext="#{customer.comments}"/>
                <textarea cols="110" id="customer.comments" name="customer.comments" rows="8" th:utext="${customer.comments}"></textarea>
            </label>
        </fieldset>
    </form>
    <th:block th:insert="~{fragments/elements/audit::audit('customer.addedBy','customer.addedOn', 'customer.lastEditedBy', 'customer.lastEditedOn')}"></th:block>
</section>
</body>
</html>