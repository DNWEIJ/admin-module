<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chess vs Computer</title>

    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #222;
            color: #eee;
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }
        #game {
            display: flex;
            gap: 20px;
        }
        #board {
            display: grid;
            grid-template-columns: repeat(8, 64px);
            border: 2px solid #555;
        }
        .square {
            width: 64px;
            height: 64px;
            font-size: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .light { background: #f0d9b5; }
        .dark { background: #b58863; }
        .selected { outline: 3px solid red; }
        .move { box-shadow: inset 0 0 0 4px rgba(0,0,0,0.3); }

        button {
            margin: 4px 0;
            width: 140px;
        }
        textarea {
            width: 140px;
            height: 140px;
        }
    </style>
</head>
<body>

<div id="game">
    <div id="board"></div>

    <div>
        <button onclick="flipBoard()">Flip board</button>
        <button onclick="newGame()">New game</button>
        <button onclick="saveGame()">Save PGN</button>
        <button onclick="loadGame()">Load PGN</button>
        <textarea id="pgn"></textarea>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stockfish@16/stockfish.min.js"></script>

<script>
    const boardEl = document.getElementById("board");
    const game = new Chess();
    const stockfish = Stockfish();

    let selected = null;
    let legalMoves = [];
    let flipped = false;

    const pieces = {
        p:"♟", r:"♜", n:"♞", b:"♝", q:"♛", k:"♚",
        P:"♙", R:"♖", N:"♘", B:"♗", Q:"♕", K:"♔"
    };

    stockfish.postMessage("uci");

    function draw() {
        boardEl.innerHTML = "";
        const board = game.board();
        const ranks = flipped ? [...board] : [...board].reverse();

        ranks.forEach((rank, r) => {
            const files = flipped ? [...rank].reverse() : rank;
            files.forEach((piece, c) => {
                const sq = document.createElement("div");
                const isLight = (r + c) % 2 === 0;
                sq.className = `square ${isLight ? "light" : "dark"}`;

                if (piece) sq.textContent = pieces[piece.color === "w" ? piece.type.toUpperCase() : piece.type];

                const file = String.fromCharCode(97 + (flipped ? 7 - c : c));
                const rankN = flipped ? r + 1 : 8 - r;
                const square = file + rankN;

                if (square === selected) sq.classList.add("selected");
                if (legalMoves.includes(square)) sq.classList.add("move");

                sq.onclick = () => click(square);
                boardEl.appendChild(sq);
            });
        });
    }

    function click(square) {
        if (selected) {
            if (game.move({ from: selected, to: square, promotion: "q" })) {
                selected = null;
                legalMoves = [];
                draw();
                setTimeout(aiMove, 200);
            } else {
                selected = null;
                legalMoves = [];
            }
        } else {
            if (game.get(square)?.color === "w") {
                selected = square;
                legalMoves = game.moves({ square, verbose: true }).map(m => m.to);
            }
        }
        draw();
    }

    function aiMove() {
        if (game.game_over()) return;

        stockfish.postMessage("position fen " + game.fen());
        stockfish.postMessage("go depth 15");

        stockfish.onmessage = e => {
            const msg = e.data || e;
            if (msg.startsWith("bestmove")) {
                const move = msg.split(" ")[1];
                game.move({ from: move.substring(0,2), to: move.substring(2,4), promotion: "q" });
                draw();
            }
        };
    }

    function flipBoard() {
        flipped = !flipped;
        draw();
    }

    function newGame() {
        game.reset();
        draw();
    }

    function saveGame() {
        document.getElementById("pgn").value = game.pgn();
    }

    function loadGame() {
        game.load_pgn(document.getElementById("pgn").value);
        draw();
    }

    draw();
</script>
</body>
</html>